<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title th:text="${pageTitle}">Home - Postify</title>
  <th:block th:replace="fragments/site-head :: siteHead"></th:block>
</head>
<body class="min-h-screen relative text-slate-900">

<!-- Navbar -->
<div th:replace="~{fragments/navbar :: navbar}"></div>

<!-- Main Container -->
<div class="max-w-3xl mx-auto mt-10 px-4 pb-12">

  <!-- Posts Feed -->
  <div th:each="post : ${posts}"
       class="card card-hover p-6 mb-6">

    <!-- Post Header -->
    <div class="flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <img th:src="${post.user.avatarUrl != null ? post.user.avatarUrl : '/images/default-avatar.png'}"
             class="w-10 h-10 rounded-full border-2 border-teal-500"/>

        <a th:href="@{'/profile/' + ${post.user.username}}"
           class="font-semibold text-slate-800 hover:text-teal-700"
           th:text="${post.user.username}"></a>
      </div>

      <!-- Delete Button -->
      <div th:if="${currentUser != null and currentUser.username == post.user.username}">
        <form th:action="@{/posts/delete/{id}(id=${post.id})}" method="post">
          <button type="submit"
                  class="px-3 py-1 bg-rose-100 text-rose-700 font-semibold rounded-lg hover:bg-rose-200 hover:text-rose-800 transition">
            Delete
          </button>
        </form>
      </div>
    </div>

    <!-- Post Content -->
    <p class="mt-4 text-slate-700 text-base"
       th:if="${post.content != null}"
       th:text="${post.content}"></p>

    <!-- Post Image -->
    <div th:if="${post.imageUrl != null}" class="mt-4">
      <img th:src="${post.imageUrl}"
           class="w-full rounded-2xl border border-slate-200 object-cover"
           alt="Post image"/>
    </div>

    <!-- Timestamp -->
    <div class="text-sm text-slate-400 mt-2"
         th:text="${#temporals.format(post.createdAt, 'dd MMM yyyy HH:mm')}"></div>

    <!-- Like + Comment Section -->
    <div class="flex items-center mt-4 space-x-3" th:if="${currentUser != null}">
      <button type="button"
              class="like-btn flex items-center space-x-2 px-4 py-1 rounded-xl transition shadow-sm"
              th:classappend="${likeService.isLikedByUser(post.id, currentUser) ? ' bg-amber-100 text-amber-700' : ' bg-slate-100 text-slate-600 hover:bg-slate-200'}"
              th:data-post-id="${post.id}">
        <span class="like-icon" th:text="${likeService.isLikedByUser(post.id, currentUser) ? 'â¤ï¸' : 'ðŸ¤'}"></span>
        <span class="like-count" th:text="${likeService.countLikes(post.id)}"></span>
      </button>

      <button type="button"
              class="comment-toggle flex items-center space-x-2 px-4 py-1 rounded-xl bg-slate-100 text-slate-700 hover:bg-slate-200 transition shadow-sm"
              th:data-post-id="${post.id}">
        <span>ðŸ’¬</span>
        <span class="comment-count" th:text="${commentService.countComments(post.id)}"></span>
      </button>
    </div>

    <!-- Comments -->
    <div class="comment-section mt-3 bg-white/80 rounded-2xl p-4 border border-slate-100 hidden"
         th:data-post-id="${post.id}"
         th:if="${currentUser != null}">
      <div class="comment-list space-y-3 text-sm text-slate-800"></div>

      <form class="comment-form mt-3 flex space-x-2">
        <input type="text"
               name="content"
               placeholder="Add a comment..."
               class="flex-1 input-base" />
        <button type="submit"
                class="px-4 py-2 rounded-xl btn-primary">
          Post
        </button>
      </form>
    </div>
  </div>

  <!-- Load More -->
  <div th:if="${posts.hasNext()}"
       class="flex justify-center mb-10">
    <form th:action="@{/}" method="get" class="flex">
      <input type="hidden" name="page" th:value="${posts.number + 1}"/>
      <input type="hidden" name="size" th:value="${pageSize}"/>
      <input type="hidden" name="keyword" th:value="${keyword}"/>
      <button type="submit"
              class="px-5 py-2 rounded-xl btn-primary">
        Load more
      </button>
    </form>
  </div>

</div>

<!-- ============================== -->
<!-- Floating + Add Post Button (CSS-only Modal) -->
<!-- ============================== -->

<!-- Hidden checkbox toggle -->
<input type="checkbox" id="addPostToggle" class="hidden peer">

<!-- Floating + button -->
<label for="addPostToggle"
       class="fixed bottom-8 right-8 w-14 h-14 bg-teal-600 text-white text-3xl rounded-full shadow-xl flex items-center justify-center cursor-pointer hover:bg-teal-700 active:scale-95 transition-all duration-200 peer-checked:bg-teal-800">
  +
</label>

<!-- Modal Overlay -->
<div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-300
            peer-checked:pointer-events-auto peer-checked:opacity-100">
  <div class="bg-white/95 w-full max-w-lg p-6 rounded-3xl shadow-2xl relative">

    <label for="addPostToggle"
           class="absolute top-4 right-4 text-slate-400 hover:text-rose-500 text-xl cursor-pointer">
      âœ•
    </label>

    <h2 class="text-xl font-semibold mb-4">Create Post</h2>

    <form th:action="@{/posts/create}" method="post" enctype="multipart/form-data">
      <textarea name="content"
                rows="4"
                placeholder="What's on your mind?"
                class="w-full input-base resize-none"
                ></textarea>

      <div class="mt-3">
        <label class="block text-sm font-medium text-slate-700 mb-1">Attach image (optional)</label>
        <input type="file" name="image" accept="image/*"
               class="w-full text-sm text-slate-700 file:mr-3 file:py-2 file:px-4 file:rounded-xl file:border-0 file:bg-teal-100 file:text-teal-800 hover:file:bg-teal-200"/>
      </div>

      <div class="flex justify-end mt-4">
        <button type="submit"
                class="px-5 py-2 rounded-2xl btn-primary">
          Post
        </button>
      </div>
    </form>

  </div>
</div>

<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', () => {

      // Likes
      document.addEventListener('click', function(e) {
          const button = e.target.closest('.like-btn');
          if (!button) return;

          const postId = button.dataset.postId;

          fetch(`/posts/${postId}/like`, { method: 'POST' })
          .then(res => res.json())
          .then(data => {
              const icon = button.querySelector('.like-icon');
              icon.textContent = data.liked ? 'â¤ï¸' : 'ðŸ¤';

              const count = button.querySelector('.like-count');
              count.textContent = data.count;

              button.classList.toggle('bg-amber-100', data.liked);
              button.classList.toggle('text-amber-700', data.liked);
              button.classList.toggle('bg-slate-100', !data.liked);
              button.classList.toggle('text-slate-600', !data.liked);
          })
          .catch(err => console.error("Like request failed:", err));
      });

      // Comments: toggle, load, submit
      async function renderComments(postId, section) {
          if (section.dataset.loaded === "true") return;
          const list = section.querySelector('.comment-list');
          list.innerHTML = '<div class="text-slate-400 text-sm">Loading comments...</div>';
          try {
              const res = await fetch(`/posts/${postId}/comments`);
              const data = await res.json();
              list.innerHTML = '';
              data.forEach(c => appendComment(list, c));
              section.dataset.loaded = "true";
          } catch (err) {
              list.innerHTML = '<div class="text-red-500 text-sm">Failed to load comments.</div>';
          }
      }

      function appendComment(listEl, c) {
          const row = document.createElement('div');
          row.className = 'flex space-x-3 items-start';
          row.innerHTML = `
            <img src="${c.avatar || '/images/default-avatar.png'}" class="w-8 h-8 rounded-full border border-slate-200" />
            <div class="bg-white border border-slate-100 rounded-2xl px-3 py-2 shadow-sm flex-1">
              <div class="text-xs text-slate-500 flex justify-between">
                <span class="font-semibold text-slate-800">@${c.user}</span>
                <span>${c.createdAt}</span>
              </div>
              <div class="text-sm text-slate-800 mt-1 whitespace-pre-line">${c.content}</div>
            </div>
          `;
          listEl.appendChild(row);
      }

      document.addEventListener('click', async (e) => {
          const toggle = e.target.closest('.comment-toggle');
          if (!toggle) return;
          const postId = toggle.dataset.postId;
          const section = document.querySelector(`.comment-section[data-post-id="${postId}"]`);
          if (!section) return;
          section.classList.toggle('hidden');
          if (!section.classList.contains('hidden')) {
              await renderComments(postId, section);
          }
      });

      document.addEventListener('submit', async (e) => {
          const form = e.target.closest('.comment-form');
          if (!form) return;
          e.preventDefault();
          const section = form.closest('.comment-section');
          const postId = section.dataset.postId;
          const input = form.querySelector('input[name="content"]');
          const content = input.value.trim();
          if (!content) return;

          try {
              const res = await fetch(`/posts/${postId}/comments`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                  body: new URLSearchParams({ content })
              });
              const data = await res.json();
              if (data.error) {
                  alert(data.error);
                  return;
              }
              const list = section.querySelector('.comment-list');
              appendComment(list, data);
              input.value = '';

              const countBadge = document.querySelector('.comment-toggle[data-post-id="' + postId + '"] .comment-count');
              if (countBadge) countBadge.textContent = parseInt(countBadge.textContent || '0', 10) + 1;
          } catch (err) {
              alert('Failed to post comment.');
          }
      });

      // Real-time notifications (SSE)
      const isAuthenticated = /*[[${currentUser != null}]]*/ false;
      if (isAuthenticated) {
          startNotifications();
      }

      function startNotifications() {
          const evt = new EventSource('/notifications/stream');
          evt.addEventListener('notification', (event) => {
              try {
                  const data = JSON.parse(event.data);
                  if (data.type === 'init') return;
                  showToast(data);
              } catch (err) {
                  console.error('Notification parse error', err);
              }
          });
          evt.onerror = () => {
              evt.close();
              setTimeout(startNotifications, 5000);
          };
      }

      function showToast(data) {
          const container = getToastContainer();
          const toast = document.createElement('div');
          toast.className = 'transform transition-all duration-300 translate-x-0 opacity-100 bg-gradient-to-r from-teal-600 to-amber-500 text-white shadow-2xl rounded-2xl px-4 py-3 mb-3 flex items-start space-x-3';
          toast.innerHTML = `
            <div class="text-xl">${iconFor(data.type)}</div>
            <div class="flex-1">
              <div class="font-semibold capitalize">${data.type}</div>
              <div class="text-sm leading-snug">${data.message}</div>
              ${data.link ? `<a href="${data.link}" class="text-xs underline text-white/90">View</a>` : ''}
            </div>
            <button class="text-white/70 hover:text-white text-lg">&times;</button>
          `;
          toast.querySelector('button').addEventListener('click', () => dismissToast(toast));
          container.appendChild(toast);
          setTimeout(() => dismissToast(toast), 5000);
      }

      function iconFor(type) {
          if (type === 'like') return 'â¤ï¸';
          if (type === 'comment') return 'ðŸ’¬';
          if (type === 'follow') return 'â­';
          return 'ðŸ””';
      }

      function dismissToast(toast) {
          toast.classList.add('translate-x-4', 'opacity-0');
          setTimeout(() => toast.remove(), 250);
      }

      function getToastContainer() {
          let el = document.querySelector('#toast-container');
          if (!el) {
              el = document.createElement('div');
              el.id = 'toast-container';
              el.className = 'fixed top-6 right-6 z-50 w-80';
              document.body.appendChild(el);
          }
          return el;
      }

  });
</script>

</body>
</html>
